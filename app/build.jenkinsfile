pipeline {
    agent {
        docker {
            image "eldiabloj/dockerfile_agent:latest"
            args "--user root -v /var/run/docker.sock:/var/run/docker.sock"
        }
    }

    environment {
        IMG_NAME = "polybot:${BUILD_NUMBER}"
        DOCKER_REGISTRY = "eldiabloj/polybot"
        SNYK_TOKEN = credentials("SNYK_TOKEN")
    }

    parameters {
        string(name: 'IMAGE_TAG', defaultValue: '', description: 'eldiabloj/polybot:latest')
    }

    stages {
        stage('Build Docker Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'docker-jenkinse', usernameVariable: 'USERNAME', passwordVariable: 'USERPASS')]) {
                    script {
                        try {
                            dir('app') {
                                sh "docker login -u ${USERNAME} -p ${USERPASS}"
                                sh "docker build -t ${IMG_NAME} ."
                            }
                        } catch (Exception e) {
                            echo "Docker build failed: ${e.message}"
                            error "Build failed: ${e.message}"
                        }
                    }
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    sh "docker tag ${IMG_NAME} ${DOCKER_REGISTRY}:${BUILD_NUMBER}"
                    sh "docker push ${DOCKER_REGISTRY}:${BUILD_NUMBER}"
                }
            }
        }

        stage('Deploy polybot') {
            steps {
                script {
                    echo "Deploying to Kubernetes cluster..."
                    echo "Using Docker image: ${params.IMAGE_TAG}"
                    echo "kubectl set image deployment/polybot polybot=${params.IMAGE_TAG}"
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    docker.image("${DOCKER_REGISTRY}:${BUILD_NUMBER}").inside("-w /app") {
                        sh '''
                        python3 -m venv venv
                        . venv/bin/activate
                        pip install -r app/requirements.txt
                        pylint --disable=C0301,C0114,E1101,C0116,C0103,W0718,E0401,W0613,R1722,W0612,R0912,C0304,C0115,R1705,E1136 app/polybot/*.py
                        deactivate
                        '''
                    }
                }
            }
        }

        stage('Verify Docker Image') {
            steps {
                script {
                    sh "docker images ${IMG_NAME}"
                }
            }
        }

        stage('Snyk Scan') {
            steps {
                script {
                    withCredentials([
                        string(credentialsId: 'SNYK_TOKEN', variable: 'SNYK_TOKEN')
                    ]) {
                        sh "snyk auth ${SNYK_TOKEN}"
                        echo "snyk container test ${IMG_NAME} --policy-path=.snyk"
                    }
                }
            }
        }

        stage('Unit Test') {
            steps {
                script {
                    echo "Starting Unit Tests"
                    docker.image("${DOCKER_REGISTRY}:${BUILD_NUMBER}").inside {
                        sh '''
                        echo "Current directory:"
                        pwd


                        python3 -m venv venv
                        . venv/bin/activate
                        pip install --upgrade pip
                        pip install -r app/requirements.txt
                        pip install pytest-xdist pytest-timeout

                        # Run pytest with verbosity and timeout for each test
                        python3 -m pytest -n 4 --timeout=60 --junitxml results.xml app/test/*.py
                        deactivate
                        '''
                    }
                    echo "Unit Tests completed"
                }
            }
        }
    }



    post {
        always {
            script {
                def DOCKER_REGISTRY = env.DOCKER_REGISTRY
                def containerId = sh(script: "docker ps -q -f ancestor=${DOCKER_REGISTRY}:${BUILD_NUMBER}", returnStdout: true).trim()

                sh """
                    for id in \$(docker ps -a -q -f ancestor=${DOCKER_REGISTRY}:${BUILD_NUMBER}); do
                        if [ "\$id" != "${containerId}" ]; then
                            docker rm -f \$id || true
                        fi
                    done
                """
            }
            script {
                sh """
                    docker images --format '{{.Repository}}:{{.Tag}} {{.ID}}' | grep '${DOCKER_REGISTRY}' | grep -v ':latest' | grep -v ':${BUILD_NUMBER}' | awk '{print \$2}' | xargs --no-run-if-empty docker rmi -f || true
                """
            }

            cleanWs()
        }
    }
}








//        stage('Unit Test') {
//             steps {
//                 script {
//                     echo "Starting Unit Tests"
//                     docker.image("${DOCKER_REGISTRY}:${BUILD_NUMBER}").inside {
//                         sh """
//                         python3 -m venv venv
//                         . venv/bin/activate
//                         pip install --upgrade pip
//                         pip install -r app/requirements.txt
//                         pip install pytest-xdist pytest-timeout
//                         # Run pytest with verbosity and timeout for each test
//                         python3 -m pytest -n 4 --timeout=60 --junitxml results.xml tests/*.py
//                         deactivate
//                         """
//                     }
//                     echo "Unit Tests completed"
//                 }
//             }
//         }
//     }
// vir9
// pipeline {
//     agent {
//         docker {
//             image "eldiabloj/polybot:tagname"
//             args "oj@ubuntu -v /var/run/docker.sock:/var/run/docker.sock"
//         }
//     }
//
//     environment {
//         IMG_NAME = "polybot:${BUILD_NUMBER}"
//         DOCKER_REGISTRY = "eldiabloj/polybot"
//         SNYK_TOKEN = credentials("snyk-jenkins")
//     }
//
//     parameters {
//         string(name: 'IMAGE_TAG', defaultValue: '', description: 'eldiabloj/polybot:latest')
//     }
//
//     stages {
//         stage('Build Docker Image') {
//             steps {
//                 withCredentials([usernamePassword(credentialsId: 'docker-jenkinse', usernameVariable: 'USERNAME', passwordVariable: 'USERPASS')]) {
//                     script {
//                         try {
//                             dir('app') {
//                                 sh "docker login -u ${USERNAME} -p ${USERPASS}"
//                                 sh "docker build -t ${IMG_NAME} ."
//                             }
//                         } catch (Exception e) {
//                             echo "Docker build failed: ${e.message}"
//                             error "Build failed: ${e.message}"
//                         }
//                     }
//                 }
//             }
//         }
//
//         stage('Snyk Scan') {
//             steps {
//                 script {
//                     // Assuming you have credentials IDs 'username-password' and 'ssh-key' configured in Jenkins
//                     withCredentials([
//                         usernamePassword(credentialsId: 'SNYK_TOKEN', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD'),
//                         string(credentialsId: 'ssh-key', variable: 'SSH_KEY')
//                     ]) {
//                         // Access the username and password from environment variables
//                         sh "echo Username: $USERNAME"
//                         sh "echo Password: ****"  // Password will be masked
//
//                         sh """
//                           snyk auth
//                           snyk test --docker ${IMG_NAME}
//                         """
//                     }
//                 }
//             }
//         }
//
//         stage('Push Docker Image') {
//             steps {
//                 script {
//                     sh "docker tag ${IMG_NAME} ${DOCKER_REGISTRY}:${BUILD_NUMBER}"
//                     sh "docker push ${DOCKER_REGISTRY}:${BUILD_NUMBER}"
//                 }
//             }
//         }
//
//         stage('Deploy polybot') {
//             steps {
//                 script {
//                     echo "Deploying to Kubernetes cluster..."
//                     echo "Using Docker image: ${params.IMAGE_TAG}"
//                     sh "kubectl set image deployment/polybot polybot=${params.IMAGE_TAG}"
//                 }
//             }
//         }
//
//         stage('Test') {
//             steps {
//                 script {
//                     docker.image("${DOCKER_REGISTRY}:${BUILD_NUMBER}").inside("-w /app") {
//                         sh '''
//                         python3 -m venv venv
//                         . venv/bin/activate
//                         pip install -r app/requirements.txt
//                         pylint --disable=C0301,C0114,E1101,C0116,C0103,W0718,E0401,W0613,R1722,W0612,R0912,C0304,C0115,R1705,E1136 app/polybot/*.py
//                         deactivate
//                         '''
//                     }
//                 }
//             }
//         }
//     }
//
//     post {
//         always {
//             node {
//                 script {
//                     try {
//                         // Clean up old containers but not the new one
//                         sh """
//                             docker ps -a -q -f ancestor=${DOCKER_REGISTRY}:${BUILD_NUMBER} | grep -v `docker ps -q -f ancestor=${DOCKER_REGISTRY}:${BUILD_NUMBER}` | xargs docker rm -f
//                         """
//                     } catch (Exception e) {
//                         echo "Error cleaning up old containers: ${e.message}"
//                     }
//
//                     try {
//                         // Clean up old Docker images but keep the new one
//                         sh "docker images -q ${DOCKER_REGISTRY}:${BUILD_NUMBER} | xargs docker rmi -f"
//                     } catch (Exception e) {
//                         echo "Error cleaning up old Docker images: ${e.message}"
//                     }
//
//                     // Clean build artifacts from Jenkins workspace
//                     cleanWs()
//                 }
//             }
//         }
//     }
// }